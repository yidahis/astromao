<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroMao - ç¦»çº¿è¯­éŸ³è¯†åˆ«</title>
    <!-- å¼•å…¥crypto-jsåº“ç”¨äºMD5è®¡ç®— -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: visible;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-section.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            display: none;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-section {
            display: none;
        }

        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 150px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .full-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .sentences-container {
            background: white;
            border-radius: 10px;
            overflow: visible;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .sentences-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 10px 10px 0 0;
        }

        .sentences-list-wrapper {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            border-radius: 0 0 10px 10px;
        }

        .sentence-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .sentence-item:hover {
            background: #f0f8ff;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);
        }

        .sentence-item.playing {
            background: #e3f2fd;
            border-left: 4px solid #4facfe;
        }

        .sentence-item.edit-mode {
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .sentence-item.edit-mode:hover {
            background: #e8f5e8;
        }

        .sentence-item.selected {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .sentence-item.selected::before {
            content: 'âœ“';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }

        .sentence-item::before {
            content: 'ğŸµ';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sentence-item:hover::before {
            opacity: 0.6;
        }

        .sentence-item:last-child {
            border-bottom: none;
        }

        .sentence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .speaker-tag {
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        .sentence-text {
            color: #333;
            line-height: 1.5;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #00b894;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .supported-formats {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats {
                flex-direction: column;
            }

            .sentence-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ï¸ AstroMao</h1>
            <p>ç¦»çº¿è¯­éŸ³è¯†åˆ« Â· è¯´è¯äººåˆ†ç¦» Â· ä¸­è‹±æ–‡æ”¯æŒ</p>
        </div>

        <div class="main-content">
            <div class="upload-section" id="uploadSection">
                <h3>ğŸ“ ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æˆ–å¯¼å…¥è¯†åˆ«ç»“æœ</h3>
                <p>æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å¯¼å…¥ä¹‹å‰ä¿å­˜çš„JSONç»“æœæ–‡ä»¶</p>
                <input type="file" id="fileInput" class="file-input" accept=".wav,.mp3,.m4a,.flac,.aac,.ogg">
                <input type="file" id="jsonInput" class="file-input" accept=".json">
                <input type="file" id="audioForJsonInput" class="file-input" accept=".wav,.mp3,.m4a,.flac,.aac,.ogg" style="display: none;">
                <button class="upload-btn" id="uploadBtn">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</button>
                <button class="upload-btn" id="importBtn" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">ğŸ“¥ å¯¼å…¥JSONç»“æœ</button>
                <button class="upload-btn" id="selectAudioBtn" style="background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%); display: none;">ğŸµ é€‰æ‹©å¯¹åº”éŸ³é¢‘</button>
                <button class="upload-btn" id="recognizeBtn" style="display: none;" disabled>å¼€å§‹è¯†åˆ«</button>
                <button class="upload-btn" id="historyBtn" style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);">ğŸ“‹ å†å²è®°å½•</button>
                
                <div class="file-info" id="fileInfo">
                    <p><strong>æ–‡ä»¶å:</strong> <span id="fileName"></span></p>
                    <p><strong>æ–‡ä»¶å¤§å°:</strong> <span id="fileSize"></span></p>
                    <p><strong>æ–‡ä»¶ç±»å‹:</strong> <span id="fileType"></span></p>
                </div>

                <div class="supported-formats">
                    éŸ³é¢‘æ ¼å¼: WAV, MP3, M4A, FLAC, AAC, OGG | ç»“æœæ ¼å¼: JSON
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p style="text-align: center; margin-top: 10px;">æ­£åœ¨å¤„ç†éŸ³é¢‘æ–‡ä»¶...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h3>ğŸ“Š è¯†åˆ«ç»“æœ</h3>
                    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
                    <audio id="audioPlayer" controls style="width: 100%; margin-top: 15px; display: none;">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                    </audio>
                </div>

                <div class="stats" id="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDuration">0</div>
                        <div class="stat-label">æ€»æ—¶é•¿ (ç§’)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="sentenceCount">0</div>
                        <div class="stat-label">å¥å­æ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="speakerCount">0</div>
                        <div class="stat-label">è¯´è¯äººæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="wordCount">0</div>
                        <div class="stat-label">å­—ç¬¦æ•°</div>
                    </div>
                </div>

                <div class="full-text">
                    <h4>ğŸ“ å®Œæ•´æ–‡æœ¬</h4>
                    <div id="fullText"></div>
                </div>

                <div class="result-actions" id="resultActions" style="display: none; padding: 20px; background: #f8f9fa; border-top: 1px solid #eee; text-align: center;">
                    <button onclick="saveResult()" style="background: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 0 10px; cursor: pointer;">ğŸ’¾ ä¿å­˜ç»“æœ</button>
                    <button onclick="exportResult()" style="background: #4facfe; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 0 10px; cursor: pointer;">ğŸ“¥ å¯¼å‡ºJSON</button>
                </div>

                <div class="sentences-container">
                    <div class="sentences-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee;">
                            <h4 style="margin: 0;">ğŸ¯ åˆ†å¥ç»“æœ</h4>
                            <div style="display: flex; gap: 10px;">
                                <button id="bilingualModeBtn" onclick="toggleBilingualMode()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-block; font-size: 14px; line-height: 1.4; text-align: center; vertical-align: middle; -webkit-appearance: none; -moz-appearance: none; appearance: none;" title="åŒè¯­æ¨¡å¼">ğŸŒ åŒè¯­æ¨¡å¼</button>
                                <button id="editModeBtn" onclick="toggleEditMode()" style="background: #fd79a8; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-block; font-size: 14px; line-height: 1.4; text-align: center; vertical-align: middle; -webkit-appearance: none; -moz-appearance: none; appearance: none;">âœï¸ ç¼–è¾‘æ¨¡å¼</button>
                            </div>
                        </div>
                        <div id="editControlPanel" style="display: none; padding: 10px 20px; background: #f1f3f5; border-bottom: 1px solid #eee;">
                            <span id="selectedCount" style="margin-right: 15px; font-weight: bold;">å·²é€‰æ‹©: 0</span>
                            <button id="mergeBtn" onclick="mergeSelectedSentences()" style="background: #20c997; color: white; border: none; padding: 5px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer; opacity: 0.6;" disabled>ğŸ”„ åˆå¹¶é€‰ä¸­</button>
                            <button onclick="clearSelection()" style="background: #868e96; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">âŒ æ¸…é™¤é€‰æ‹©</button>
                        </div>
                    </div>
                    <div class="sentences-list-wrapper">
                        <div id="sentencesList"></div>
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
            <div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ğŸ“‹ è¯†åˆ«ç»“æœå†å²è®°å½•</h3>
                        <button onclick="closeHistoryModal()" style="background: #ddd; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">âœ•</button>
                    </div>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const jsonInput = document.getElementById('jsonInput');
        const audioForJsonInput = document.getElementById('audioForJsonInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const importBtn = document.getElementById('importBtn');
        const selectAudioBtn = document.getElementById('selectAudioBtn');
        const recognizeBtn = document.getElementById('recognizeBtn');
        const historyBtn = document.getElementById('historyBtn');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        let selectedFile = null;
        let importedJsonData = null;
        let selectedAudioForJson = null;
        
        // å°†ç§’æ•°è½¬æ¢ä¸ºæ—¶åˆ†ç§’æ ¼å¼
        function formatTimeToHMS(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const millisecs = Math.floor((seconds % 1) * 100);
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millisecs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millisecs.toString().padStart(2, '0')}`;
            }
        }
        
        // ç¡®ä¿DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå·²åŠ è½½å®Œæˆ');
            // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
            const editModeBtn = document.getElementById('editModeBtn');
            const editControlPanel = document.getElementById('editControlPanel');
            const bilingualModeBtn = document.getElementById('bilingualModeBtn');
            console.log('ç¼–è¾‘æ¨¡å¼æŒ‰é’®:', editModeBtn);
            console.log('ç¼–è¾‘æ§åˆ¶é¢æ¿:', editControlPanel);
            console.log('åŒè¯­æ¨¡å¼æŒ‰é’®:', bilingualModeBtn);
        });

        // File input change event
        fileInput.addEventListener('change', handleFileSelect);
        jsonInput.addEventListener('change', handleJsonImport);
        audioForJsonInput.addEventListener('change', handleAudioForJsonSelect);
        uploadBtn.addEventListener('click', () => fileInput.click());
        importBtn.addEventListener('click', () => jsonInput.click());
        selectAudioBtn.addEventListener('click', () => audioForJsonInput.click());
        recognizeBtn.addEventListener('click', recognizeAudio);
        historyBtn.addEventListener('click', showResultsHistory);

        // Drag and drop events
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // é‡ç½®JSONå¯¼å…¥ç›¸å…³çŠ¶æ€
                resetJsonImportState();
                handleFile(file);
            }
        }

        function handleFile(file) {
            selectedFile = file;
            
            // Display file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || 'Unknown';
            
            fileInfo.style.display = 'block';
            recognizeBtn.style.display = 'inline-block';
            recognizeBtn.disabled = false;
            
            hideMessages();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function recognizeAudio() {
            if (!selectedFile) {
                alert('éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½ï¼Œè¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('audio', selectedFile);

            // Show progress
            progressContainer.style.display = 'block';
            recognizeBtn.disabled = true;
            recognizeBtn.innerHTML = '<span class="loading"></span>è¯†åˆ«ä¸­...';
            hideMessages();
            resultsSection.style.display = 'none';

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
            }, 200);

            try {
                const response = await fetch('/api/recognize', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    recognizeBtn.disabled = false;
                    recognizeBtn.innerHTML = 'é‡æ–°è¯†åˆ«';

                    if (result.success) {
                        displayResults(result);
                        
                        // è¯†åˆ«å®Œæˆåè‡ªåŠ¨ä¿å­˜éŸ³é¢‘æ–‡ä»¶åˆ°resultsæ–‡ä»¶å¤¹
                        if (selectedFile && result.result_id) {
                            console.log('è¯†åˆ«å®Œæˆï¼Œå¼€å§‹ä¿å­˜éŸ³é¢‘æ–‡ä»¶åˆ°resultsæ–‡ä»¶å¤¹...');
                            uploadAudioForResult(selectedFile, result.result_id);
                        }
                        
                        showSuccess('è¯†åˆ«å®Œæˆï¼');
                    } else {
                        showError(result.message || 'è¯†åˆ«å¤±è´¥');
                    }
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                progressContainer.style.display = 'none';
                progressFill.style.width = '0%';
                recognizeBtn.disabled = false;
                recognizeBtn.innerHTML = 'å¼€å§‹è¯†åˆ«';
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        let currentResult = null; // å­˜å‚¨å½“å‰è¯†åˆ«ç»“æœ
        let audioPlayer = null; // éŸ³é¢‘æ’­æ”¾å™¨å¼•ç”¨
        let currentAudioFile = null; // å½“å‰éŸ³é¢‘æ–‡ä»¶
        let isEditMode = false; // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
        let isBilingualMode = true; // åŒè¯­æ¨¡å¼çŠ¶æ€ï¼Œé»˜è®¤å¼€å¯
        let selectedSentences = new Set(); // é€‰ä¸­çš„åˆ†å¥ç´¢å¼•

        function displayResults(result) {
            currentResult = result; // ä¿å­˜å½“å‰ç»“æœ
            
            // Update statistics
            document.getElementById('totalDuration').textContent = result.total_duration || 0;
            document.getElementById('sentenceCount').textContent = result.sentences.length;
            document.getElementById('speakerCount').textContent = result.speakers.length;
            document.getElementById('wordCount').textContent = result.text.length;

            // Display full text
            document.getElementById('fullText').textContent = result.text;

            // è®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨
            setupAudioPlayer();

            // Display sentences
            const sentencesList = document.getElementById('sentencesList');
            sentencesList.innerHTML = '';

            result.sentences.forEach((sentence, index) => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-item';
                sentenceDiv.dataset.start = sentence.start;
                sentenceDiv.dataset.end = sentence.end;
                sentenceDiv.dataset.index = index;
                
                const speakerColors = ['#4facfe', '#00f2fe', '#667eea', '#764ba2', '#f093fb', '#f5576c'];
                const speakerColor = speakerColors[index % speakerColors.length];
                
                // æ„å»ºç¿»è¯‘æ˜¾ç¤ºå†…å®¹
                let translationHtml = '';
                if (sentence.translation) {
                    const sourceFlag = sentence.translation.source_lang === 'zh' ? 'ğŸ‡¨ğŸ‡³' : 'ğŸ‡ºğŸ‡¸';
                    const targetFlag = sentence.translation.source_lang === 'zh' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸ‡¨ğŸ‡³';
                    
                    const displayStyle = isBilingualMode ? 'block' : 'none';
                    translationHtml = `
                        <div class="translation-content translation-section" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #4facfe; display: ${displayStyle};">
                            <div class="translation-item" style="margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #666; font-size: 12px;">${sourceFlag} åŸæ–‡:</span>
                                <div style="margin-top: 3px; color: #333;">${sentence.text}</div>
                            </div>
                            <div class="translation-item">
                                <span style="font-weight: bold; color: #666; font-size: 12px;">${targetFlag} ç¿»è¯‘:</span>
                                <div style="margin-top: 3px; color: #555; font-style: italic;">${sentence.translation.source_lang === 'zh' ? sentence.translation.en : sentence.translation.zh}</div>
                            </div>
                        </div>
                    `;
                }
                
                sentenceDiv.innerHTML = `
                    <div class="sentence-header">
                        <span class="speaker-tag" style="background: ${speakerColor}">${sentence.speaker}</span>
                        <span class="timestamp">ğŸµ ${formatTimeToHMS(sentence.start)} - ${formatTimeToHMS(sentence.end)} (ç‚¹å‡»æ’­æ”¾)</span>
                        <button class="edit-text-btn" onclick="toggleTextEdit(${index}, event)" style="display: none; background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px;">âœï¸ ç¼–è¾‘</button>
                    </div>
                    <div class="sentence-text" id="sentence-text-${index}">${sentence.text}</div>
                    <textarea class="sentence-edit-input" id="sentence-edit-${index}" style="display: none; width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;">${sentence.text}</textarea>
                    ${translationHtml}
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                sentenceDiv.addEventListener('click', (e) => {
                    if (isEditMode) {
                        e.preventDefault();
                        toggleSentenceSelection(index, sentenceDiv);
                    } else {
                        playAudioSegment(sentence.start, sentence.end, sentenceDiv);
                    }
                });
                
                sentencesList.appendChild(sentenceDiv);
            });

            // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
            document.getElementById('resultActions').style.display = 'block';
            
            resultsSection.style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // é‡ç½®JSONå¯¼å…¥ç›¸å…³çŠ¶æ€
        function resetJsonImportState() {
            importedJsonData = null;
            selectedAudioForJson = null;
            selectAudioBtn.style.display = 'none';
            selectAudioBtn.textContent = 'ğŸµ é€‰æ‹©å¯¹åº”éŸ³é¢‘';
            selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
            audioForJsonInput.value = '';
        }

        // å¤„ç†JSONæ–‡ä»¶å¯¼å…¥
        function handleJsonImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            // é‡ç½®ä¹‹å‰çš„çŠ¶æ€
            resetJsonImportState();

            if (!file.name.toLowerCase().endsWith('.json')) {
                showError('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    console.log('å¼€å§‹è§£æJSONæ–‡ä»¶:', file.name);
                    const jsonData = JSON.parse(event.target.result);
                    console.log('JSONè§£ææˆåŠŸï¼Œæ•°æ®ç»“æ„:', jsonData);
                    
                    // éªŒè¯JSONæ ¼å¼æ˜¯å¦æ­£ç¡®
                    if (!validateJsonFormat(jsonData)) {
                        showError('JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚ç¡®ä¿æ–‡ä»¶åŒ…å«å¿…è¦å­—æ®µï¼štextã€sentencesã€speakers');
                        return;
                    }

                    // ç¡®ä¿æ•°æ®åŒ…å«å¿…è¦çš„ç»Ÿè®¡ä¿¡æ¯
                    if (!jsonData.total_duration) {
                        jsonData.total_duration = jsonData.sentences.length > 0 ? 
                            Math.max(...jsonData.sentences.map(s => s.end)) : 0;
                    }

                    // ä¿å­˜å¯¼å…¥çš„JSONæ•°æ®
                    importedJsonData = jsonData;
                    
                    // æ˜¾ç¤ºå¯¼å…¥çš„ç»“æœ
                    displayResults(jsonData);
                    
                    // æ˜¾ç¤ºé€‰æ‹©éŸ³é¢‘æŒ‰é’®ï¼ˆå¦‚æœJSONåŒ…å«audio_hashï¼‰
                    if (jsonData.audio_hash) {
                        selectAudioBtn.style.display = 'inline-block';
                        const audioFileName = jsonData.filename ? `ï¼ˆåŸéŸ³é¢‘æ–‡ä»¶ï¼š${jsonData.filename}ï¼‰` : '';
                        showSuccess(`æˆåŠŸå¯¼å…¥è¯†åˆ«ç»“æœï¼š${file.name}ã€‚å¦‚éœ€æ’­æ”¾éŸ³é¢‘ï¼Œè¯·é€‰æ‹©å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶è¿›è¡ŒéªŒè¯${audioFileName}ã€‚`);
                    } else {
                        const audioFileName = jsonData.filename ? `ï¼ˆåŸéŸ³é¢‘æ–‡ä»¶ï¼š${jsonData.filename}ï¼‰` : '';
                        showSuccess(`æˆåŠŸå¯¼å…¥è¯†åˆ«ç»“æœï¼š${file.name}${audioFileName}`);
                    }
                    
                    // éšè—æ–‡ä»¶ä¿¡æ¯å’Œè¯†åˆ«æŒ‰é’®
                    fileInfo.style.display = 'none';
                    recognizeBtn.style.display = 'none';
                    
                } catch (error) {
                    console.error('JSONè§£æé”™è¯¯:', error);
                    showError('JSONæ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message + 'ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚');
                }
            };
            
            reader.onerror = function() {
                showError('æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            reader.readAsText(file);
        }

        // éªŒè¯JSONæ ¼å¼
        function validateJsonFormat(data) {
            // æ£€æŸ¥å¿…è¦çš„å­—æ®µ
            const requiredFields = ['text', 'sentences', 'speakers'];
            for (const field of requiredFields) {
                if (!(field in data)) {
                    console.log(`Missing required field: ${field}`);
                    return false;
                }
            }

            // æ£€æŸ¥sentencesæ•°ç»„æ ¼å¼
            if (!Array.isArray(data.sentences)) {
                console.log('sentences is not an array');
                return false;
            }

            // æ£€æŸ¥æ¯ä¸ªå¥å­çš„æ ¼å¼ï¼ˆæ›´å®½æ¾çš„éªŒè¯ï¼‰
            for (let i = 0; i < data.sentences.length; i++) {
                const sentence = data.sentences[i];
                if (!sentence.hasOwnProperty('text')) {
                    console.log(`Sentence ${i} missing text field`);
                    return false;
                }
                if (!sentence.hasOwnProperty('start') || typeof sentence.start !== 'number') {
                    console.log(`Sentence ${i} missing or invalid start field`);
                    return false;
                }
                if (!sentence.hasOwnProperty('end') || typeof sentence.end !== 'number') {
                    console.log(`Sentence ${i} missing or invalid end field`);
                    return false;
                }
                if (!sentence.hasOwnProperty('speaker')) {
                    console.log(`Sentence ${i} missing speaker field`);
                    return false;
                }
            }

            // æ£€æŸ¥speakersæ•°ç»„
            if (!Array.isArray(data.speakers)) {
                console.log('speakers is not an array');
                return false;
            }

            console.log('JSON validation passed');
            return true;
        }

        // å¤„ç†éŸ³é¢‘æ–‡ä»¶é€‰æ‹©ï¼ˆç”¨äºJSONå¯¼å…¥åçš„éŸ³é¢‘éªŒè¯ï¼‰
        function handleAudioForJsonSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!importedJsonData) {
                alert('éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½ï¼šè¯·å…ˆå¯¼å…¥JSONç»“æœæ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['audio/wav', 'audio/mpeg', 'audio/mp4', 'audio/flac', 'audio/aac', 'audio/ogg'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(wav|mp3|m4a|flac|aac|ogg)$/i)) {
                alert('éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½ï¼šä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼ï¼Œè¯·é€‰æ‹©wavã€mp3ã€m4aã€flacã€aacæˆ–oggæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
             showSuccess('æ­£åœ¨è®¡ç®—éŸ³é¢‘æ–‡ä»¶hashå€¼ï¼Œè¯·ç¨å€™...');
             
             // è®¡ç®—éŸ³é¢‘æ–‡ä»¶çš„MD5 hash
             const reader = new FileReader();
             reader.onload = function(event) {
                 try {
                     const arrayBuffer = event.target.result;
                     const calculatedHash = calculateMD5Hash(arrayBuffer);
                     
                     console.log('è®¡ç®—çš„éŸ³é¢‘hash:', calculatedHash);
                     console.log('JSONä¸­çš„hash:', importedJsonData.audio_hash);
                     
                     if (calculatedHash === importedJsonData.audio_hash) {
                         // HashåŒ¹é…ï¼Œè®¾ç½®éŸ³é¢‘æ–‡ä»¶
                         selectedAudioForJson = file;
                         selectedFile = file; // è®¾ç½®ä¸ºå½“å‰éŸ³é¢‘æ–‡ä»¶
                         setupAudioPlayer(file);
                         
                         // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ°æœåŠ¡å™¨å¹¶æ›´æ–°JSON
                         uploadAudioForResult(file, importedJsonData.result_id);
                         
                         showSuccess(`éŸ³é¢‘æ–‡ä»¶éªŒè¯æˆåŠŸï¼Hashå€¼åŒ¹é…ï¼Œç°åœ¨å¯ä»¥æ’­æ”¾éŸ³é¢‘ç‰‡æ®µã€‚`);
                         selectAudioBtn.textContent = 'âœ… éŸ³é¢‘å·²éªŒè¯';
                         selectAudioBtn.style.background = 'linear-gradient(135deg, #00b894 0%, #00cec9 100%)';
                     } else {
                         alert(`éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½ï¼šHashå€¼ä¸åŒ¹é…ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„éŸ³é¢‘æ–‡ä»¶\næœŸæœ›: ${importedJsonData.audio_hash}\nå®é™…: ${calculatedHash}`);
                     }
                 } catch (error) {
                     console.error('Hashè®¡ç®—é”™è¯¯:', error);
                     alert('éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½ï¼šhashè®¡ç®—å¤±è´¥ - ' + error.message);
                 }
             };
            
            reader.onerror = function() {
                alert('éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½ï¼šæ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ä½¿ç”¨crypto-jsè®¡ç®—MD5 hash
         function calculateMD5Hash(arrayBuffer) {
             // å°†ArrayBufferè½¬æ¢ä¸ºWordArray
             const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
             // è®¡ç®—MD5 hash
             const hash = CryptoJS.MD5(wordArray).toString();
             return hash;
         }

        // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ°æœåŠ¡å™¨å¹¶æ›´æ–°JSON
         async function uploadAudioForResult(audioFile, resultId) {
             console.log('å¼€å§‹ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶:', audioFile.name, 'resultId:', resultId);
             try {
                 const formData = new FormData();
                 formData.append('audio', audioFile);
                 
                 console.log('å‘é€ä¸Šä¼ è¯·æ±‚åˆ°:', `/api/upload_audio/${resultId}`);
                 const response = await fetch(`/api/upload_audio/${resultId}`, {
                     method: 'POST',
                     body: formData
                 });
                 
                 console.log('ä¸Šä¼ å“åº”çŠ¶æ€:', response.status);
                 const result = await response.json();
                 console.log('ä¸Šä¼ å“åº”ç»“æœ:', result);
                 
                 if (result.success) {
                     // æ›´æ–°JSONæ•°æ®ä¸­çš„éŸ³é¢‘è·¯å¾„
                     if (importedJsonData) {
                         importedJsonData.audio_path = result.audio_path;
                         console.log('å·²æ›´æ–° importedJsonData.audio_path:', result.audio_path);
                     }
                     // åŒæ—¶æ›´æ–°currentResultä¸­çš„éŸ³é¢‘è·¯å¾„
                     if (currentResult) {
                         currentResult.audio_path = result.audio_path;
                         console.log('å·²æ›´æ–° currentResult.audio_path:', result.audio_path);
                     }
                     // è‡ªåŠ¨åŒæ­¥æ›´æ–°åˆ°æœåŠ¡å™¨
                     console.log('å¼€å§‹è‡ªåŠ¨åŒæ­¥ç»“æœåˆ°æœåŠ¡å™¨...');
                     await autoSyncResult();
                     console.log('éŸ³é¢‘æ–‡ä»¶å·²ä¸Šä¼ å¹¶ä¿å­˜è·¯å¾„åˆ°JSON:', result.audio_path);
                 } else {
                     console.error('éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', result.message);
                 }
             } catch (error) {
                 console.error('éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
             }
         }

         // ä»æœåŠ¡å™¨åŠ è½½ä¿å­˜çš„éŸ³é¢‘æ–‡ä»¶
         async function loadSavedAudioFile(audioPath) {
             try {
                 const response = await fetch(`/api/audio/${audioPath}`);
                 if (response.ok) {
                     const audioBlob = await response.blob();
                     const audioFile = new File([audioBlob], audioPath, { type: audioBlob.type });
                     
                     // è®¾ç½®ä¸ºå½“å‰éŸ³é¢‘æ–‡ä»¶
                     selectedFile = audioFile;
                     selectedAudioForJson = audioFile;
                     
                     // è®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨
                     setupAudioPlayer(audioFile);
                     
                     console.log('ä¿å­˜çš„éŸ³é¢‘æ–‡ä»¶å·²åŠ è½½:', audioPath);
                 } else {
                     console.error('åŠ è½½ä¿å­˜çš„éŸ³é¢‘æ–‡ä»¶å¤±è´¥:', response.statusText);
                     // å¦‚æœéŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé€‰æ‹©éŸ³é¢‘æŒ‰é’®
                     if (importedJsonData && importedJsonData.audio_hash) {
                         selectAudioBtn.style.display = 'inline-block';
                         selectAudioBtn.textContent = 'ğŸµ é€‰æ‹©å¯¹åº”éŸ³é¢‘';
                         selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
                     }
                 }
             } catch (error) {
                 console.error('åŠ è½½ä¿å­˜çš„éŸ³é¢‘æ–‡ä»¶é”™è¯¯:', error);
                 // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé€‰æ‹©éŸ³é¢‘æŒ‰é’®
                 if (importedJsonData && importedJsonData.audio_hash) {
                     selectAudioBtn.style.display = 'inline-block';
                     selectAudioBtn.textContent = 'ğŸµ é€‰æ‹©å¯¹åº”éŸ³é¢‘';
                     selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
                 }
             }
         }

        // è®¾ç½®éŸ³é¢‘æ’­æ”¾å™¨
        function setupAudioPlayer(audioFile = null) {
            audioPlayer = document.getElementById('audioPlayer');
            const fileToUse = audioFile || selectedFile;
            
            if (fileToUse && currentAudioFile !== fileToUse) {
                currentAudioFile = fileToUse;
                const audioURL = URL.createObjectURL(fileToUse);
                audioPlayer.src = audioURL;
                audioPlayer.style.display = 'block';
                
                // æ¸…ç†ä¹‹å‰çš„URLå¯¹è±¡
                audioPlayer.addEventListener('loadstart', () => {
                    if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
                        // ä¸ç«‹å³æ¸…ç†ï¼Œç­‰æ’­æ”¾å®Œæˆåå†æ¸…ç†
                    }
                });
            }
        }

        // æ’­æ”¾éŸ³é¢‘ç‰‡æ®µ
        function playAudioSegment(startTime, endTime, sentenceElement) {
            if (!audioPlayer || !audioPlayer.src) {
                alert('éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½ï¼Œè¯·å…ˆé€‰æ‹©å¹¶åŠ è½½éŸ³é¢‘æ–‡ä»¶');
                return;
            }

            // ç§»é™¤ä¹‹å‰çš„æ’­æ”¾çŠ¶æ€
            document.querySelectorAll('.sentence-item.playing').forEach(item => {
                item.classList.remove('playing');
            });

            // æ·»åŠ å½“å‰æ’­æ”¾çŠ¶æ€
            sentenceElement.classList.add('playing');

            // è®¾ç½®æ’­æ”¾æ—¶é—´
            audioPlayer.currentTime = startTime;
            
            // æ’­æ”¾éŸ³é¢‘
            audioPlayer.play().catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                alert('éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½æˆ–æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–é‡æ–°é€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
                sentenceElement.classList.remove('playing');
            });

            // ç›‘å¬æ—¶é—´æ›´æ–°ï¼Œåœ¨æŒ‡å®šæ—¶é—´åœæ­¢
            const timeUpdateHandler = () => {
                if (audioPlayer.currentTime >= endTime) {
                    audioPlayer.pause();
                    sentenceElement.classList.remove('playing');
                    audioPlayer.removeEventListener('timeupdate', timeUpdateHandler);
                }
            };

            audioPlayer.addEventListener('timeupdate', timeUpdateHandler);

            // å¦‚æœç”¨æˆ·æ‰‹åŠ¨æš‚åœï¼Œä¹Ÿè¦ç§»é™¤æ’­æ”¾çŠ¶æ€
            const pauseHandler = () => {
                sentenceElement.classList.remove('playing');
                audioPlayer.removeEventListener('timeupdate', timeUpdateHandler);
                audioPlayer.removeEventListener('pause', pauseHandler);
            };

            audioPlayer.addEventListener('pause', pauseHandler);
        }

        // è‡ªåŠ¨åŒæ­¥æ›´æ–°ç»“æœåˆ°JSONæ–‡ä»¶
        async function autoSyncResult() {
            if (!currentResult || !currentResult.result_id) {
                // å¦‚æœæ²¡æœ‰result_idï¼Œè¯´æ˜è¿˜æ²¡æœ‰ä¿å­˜è¿‡ï¼Œå…ˆä¿å­˜
                await saveResult();
                return;
            }

            try {
                const response = await fetch(`/api/update_result/${currentResult.result_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentResult)
                });

                const result = await response.json();
                if (result.success) {
                    console.log('ç»“æœå·²è‡ªåŠ¨åŒæ­¥æ›´æ–°');
                } else {
                    console.error('è‡ªåŠ¨åŒæ­¥å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('è‡ªåŠ¨åŒæ­¥å¤±è´¥:', error.message);
            }
        }

        // ä¿å­˜è¯†åˆ«ç»“æœ
        async function saveResult() {
            if (!currentResult) {
                showError('æ²¡æœ‰å¯ä¿å­˜çš„ç»“æœ');
                return;
            }

            try {
                const response = await fetch('/api/save_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentResult)
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess(`ç»“æœå·²ä¿å­˜ï¼ID: ${result.result_id}`);
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å‡ºè¯†åˆ«ç»“æœ
        async function exportResult() {
            if (!currentResult || !currentResult.result_id) {
                showError('è¯·å…ˆä¿å­˜ç»“æœå†å¯¼å‡º');
                return;
            }

            try {
                const link = document.createElement('a');
                link.href = `/api/export/${currentResult.result_id}`;
                link.download = `astromao_result_${currentResult.result_id}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('ç»“æœå·²å¯¼å‡ºï¼');
            } catch (error) {
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        async function showResultsHistory() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();
                
                if (data.success) {
                    displayHistoryList(data.results);
                    document.getElementById('historyModal').style.display = 'block';
                } else {
                    showError('è·å–å†å²è®°å½•å¤±è´¥');
                }
            } catch (error) {
                showError('è·å–å†å²è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
        function displayHistoryList(results) {
            const historyList = document.getElementById('historyList');
            
            if (results.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            historyList.innerHTML = results.map(result => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${result.filename}</strong>
                            ${result.original_filename ? `<div style="color: #666; font-size: 0.85em; margin-top: 2px;">åŸéŸ³é¢‘: ${result.original_filename}</div>` : ''}
                        </div>
                        <span style="color: #666; font-size: 0.9em;">${new Date(result.timestamp).toLocaleString()}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <div style="color: #666; font-size: 0.9em;">éŸ³é¢‘Hash: ${result.audio_hash}</div>
                        <div style="color: #666; font-size: 0.9em;">æ—¶é•¿: ${result.total_duration}ç§’ | è¯´è¯äºº: ${result.speakers_count} | å¥å­: ${result.sentences_count}</div>
                    </div>
                    <div style="margin-bottom: 10px; color: #333;">${result.text_preview}</div>
                    <div style="text-align: right;">
                        <button onclick="loadHistoryResult('${result.result_id}')" style="background: #00b894; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 5px; cursor: pointer;">ğŸ“‚ åŠ è½½</button>
                        <button onclick="exportHistoryResult('${result.result_id}')" style="background: #4facfe; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 5px; cursor: pointer;">ğŸ“¥ å¯¼å‡º</button>
                        <button onclick="deleteHistoryResult('${result.result_id}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 5px; cursor: pointer;">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½å†å²è®°å½•ç»“æœ
        async function loadHistoryResult(resultId) {
            try {
                const response = await fetch(`/api/export/${resultId}`);
                if (!response.ok) {
                    throw new Error('è·å–å†å²è®°å½•å¤±è´¥');
                }
                
                const jsonData = await response.json();
                
                // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
                closeHistoryModal();
                
                // é‡ç½®çŠ¶æ€
                resetJsonImportState();
                selectedFile = null;
                
                // è®¾ç½®å¯¼å…¥çš„JSONæ•°æ®
                importedJsonData = jsonData;
                
                // é‡è¦ï¼šä¸ºå†å²è®°å½•æ•°æ®è®¾ç½®result_idï¼Œä»¥ä¾¿åç»­ç¼–è¾‘æ—¶èƒ½æ­£ç¡®æ›´æ–°
                jsonData.result_id = resultId;
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(jsonData);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„éŸ³é¢‘è·¯å¾„
                if (jsonData.audio_path) {
                    // è‡ªåŠ¨åŠ è½½ä¿å­˜çš„éŸ³é¢‘æ–‡ä»¶
                    loadSavedAudioFile(jsonData.audio_path);
                    const audioFileName = jsonData.filename ? `ï¼ˆåŸéŸ³é¢‘æ–‡ä»¶ï¼š${jsonData.filename}ï¼‰` : '';
                    showSuccess(`å†å²è®°å½•å·²åŠ è½½ï¼éŸ³é¢‘æ–‡ä»¶å·²è‡ªåŠ¨åŠ è½½${audioFileName}`);
                } else if (jsonData.audio_hash) {
                    // å¦‚æœæœ‰éŸ³é¢‘å“ˆå¸Œä½†æ²¡æœ‰ä¿å­˜çš„éŸ³é¢‘è·¯å¾„ï¼Œæ˜¾ç¤ºé€‰æ‹©éŸ³é¢‘æŒ‰é’®
                    selectAudioBtn.style.display = 'inline-block';
                    selectAudioBtn.textContent = 'ğŸµ é€‰æ‹©å¯¹åº”éŸ³é¢‘';
                    selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
                    const audioFileName = jsonData.filename ? `ï¼ˆåŸéŸ³é¢‘æ–‡ä»¶ï¼š${jsonData.filename}ï¼‰` : '';
                    showSuccess(`å†å²è®°å½•å·²åŠ è½½ï¼è¯·é€‰æ‹©å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶è¿›è¡ŒéªŒè¯${audioFileName}ï¼ˆéŸ³é¢‘å“ˆå¸Œ: ${jsonData.audio_hash.substring(0, 8)}...ï¼‰`);
                } else {
                    const audioFileName = jsonData.filename ? `ï¼ˆåŸéŸ³é¢‘æ–‡ä»¶ï¼š${jsonData.filename}ï¼‰` : '';
                    showSuccess(`å†å²è®°å½•å·²åŠ è½½ï¼${audioFileName}`);
                }
                
                // éšè—æ–‡ä»¶ä¿¡æ¯å’Œè¯†åˆ«æŒ‰é’®
                fileInfo.style.display = 'none';
                recognizeBtn.style.display = 'none';
                
            } catch (error) {
                showError('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å‡ºå†å²è®°å½•ç»“æœ
        async function exportHistoryResult(resultId) {
            try {
                const link = document.createElement('a');
                link.href = `/api/export/${resultId}`;
                link.download = `astromao_result_${resultId}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('ç»“æœå·²å¯¼å‡ºï¼');
            } catch (error) {
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤å†å²è®°å½•ç»“æœ
        async function deleteHistoryResult(resultId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»“æœå—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/results/${resultId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess('ç»“æœå·²åˆ é™¤ï¼');
                    showResultsHistory(); // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨
                } else {
                    showError('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editModeBtn = document.getElementById('editModeBtn');
            const editControlPanel = document.getElementById('editControlPanel');
            const sentenceItems = document.querySelectorAll('.sentence-item');
            
            // æ·»åŠ é”™è¯¯æ£€æŸ¥
            if (!editModeBtn) {
                console.error('ç¼–è¾‘æ¨¡å¼æŒ‰é’®æœªæ‰¾åˆ°');
                return;
            }
            if (!editControlPanel) {
                console.error('ç¼–è¾‘æ§åˆ¶é¢æ¿æœªæ‰¾åˆ°');
                return;
            }
            
            if (isEditMode) {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                editModeBtn.textContent = 'ğŸ‘ï¸ æŸ¥çœ‹æ¨¡å¼';
                editModeBtn.style.background = '#17a2b8';
                editControlPanel.style.display = 'block';
                
                // ä¸ºæ‰€æœ‰åˆ†å¥æ·»åŠ ç¼–è¾‘æ¨¡å¼æ ·å¼
                sentenceItems.forEach(item => {
                    item.classList.add('edit-mode');
                });
                
                // æ˜¾ç¤ºæ‰€æœ‰ç¼–è¾‘æŒ‰é’®
                document.querySelectorAll('.edit-text-btn').forEach(btn => {
                    btn.style.display = 'inline-block';
                });
                
                showSuccess('å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œç‚¹å‡»åˆ†å¥è¿›è¡Œé€‰æ‹©ï¼Œå¯é€‰æ‹©å¤šä¸ªåˆ†å¥è¿›è¡Œåˆå¹¶ï¼Œæˆ–ç‚¹å‡»ç¼–è¾‘æŒ‰é’®ä¿®æ”¹æ–‡æœ¬');
            } else {
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                editModeBtn.textContent = 'âœï¸ ç¼–è¾‘æ¨¡å¼';
                editModeBtn.style.background = '#fd79a8';
                editControlPanel.style.display = 'none';
                
                // ç§»é™¤ç¼–è¾‘æ¨¡å¼æ ·å¼å’Œé€‰ä¸­çŠ¶æ€
                sentenceItems.forEach(item => {
                    item.classList.remove('edit-mode', 'selected');
                });
                
                // éšè—æ‰€æœ‰ç¼–è¾‘æŒ‰é’®
                document.querySelectorAll('.edit-text-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // é€€å‡ºæ‰€æœ‰æ–‡æœ¬ç¼–è¾‘çŠ¶æ€
                document.querySelectorAll('.sentence-edit-input').forEach(input => {
                    input.style.display = 'none';
                });
                document.querySelectorAll('.sentence-text').forEach(text => {
                    text.style.display = 'block';
                });
                
                // æ¸…é™¤é€‰æ‹©
                selectedSentences.clear();
                updateSelectedCount();
                
                showSuccess('å·²é€€å‡ºç¼–è¾‘æ¨¡å¼');
            }
        }

        // åˆ‡æ¢åŒè¯­æ¨¡å¼
        function toggleBilingualMode() {
            isBilingualMode = !isBilingualMode;
            const bilingualModeBtn = document.getElementById('bilingualModeBtn');
            
            if (!bilingualModeBtn) {
                console.error('åŒè¯­æ¨¡å¼æŒ‰é’®æœªæ‰¾åˆ°');
                return;
            }
            
            if (isBilingualMode) {
                // å¼€å¯åŒè¯­æ¨¡å¼
                bilingualModeBtn.textContent = 'ğŸŒ åŒè¯­æ¨¡å¼';
                bilingualModeBtn.style.background = '#28a745';
                bilingualModeBtn.title = 'åŒè¯­æ¨¡å¼';
                
                // æ˜¾ç¤ºæ‰€æœ‰ç¿»è¯‘å†…å®¹
                document.querySelectorAll('.translation-content').forEach(element => {
                    element.style.display = 'block';
                });
                
                showSuccess('å·²å¼€å¯åŒè¯­æ¨¡å¼ï¼Œæ˜¾ç¤ºç¿»è¯‘å†…å®¹');
            } else {
                // å…³é—­åŒè¯­æ¨¡å¼
                bilingualModeBtn.textContent = 'ğŸ”¤ å•è¯­æ¨¡å¼';
                bilingualModeBtn.style.background = '#6c757d';
                bilingualModeBtn.title = 'å•è¯­æ¨¡å¼';
                
                // éšè—æ‰€æœ‰ç¿»è¯‘å†…å®¹
                document.querySelectorAll('.translation-content').forEach(element => {
                    element.style.display = 'none';
                });
                
                showSuccess('å·²å…³é—­åŒè¯­æ¨¡å¼ï¼Œéšè—ç¿»è¯‘å†…å®¹');
            }
        }

        // åˆ‡æ¢åˆ†å¥é€‰æ‹©çŠ¶æ€
        function toggleSentenceSelection(index, sentenceElement) {
            if (selectedSentences.has(index)) {
                selectedSentences.delete(index);
                sentenceElement.classList.remove('selected');
            } else {
                selectedSentences.add(index);
                sentenceElement.classList.add('selected');
            }
            
            updateSelectedCount();
        }

        // æ›´æ–°é€‰ä¸­è®¡æ•°
        function updateSelectedCount() {
            const count = selectedSentences.size;
            document.getElementById('selectedCount').textContent = count;
            
            const mergeBtn = document.getElementById('mergeBtn');
            mergeBtn.disabled = count < 2;
            
            if (count >= 2) {
                mergeBtn.style.background = '#28a745';
                mergeBtn.style.cursor = 'pointer';
            } else {
                mergeBtn.style.background = '#6c757d';
                mergeBtn.style.cursor = 'not-allowed';
            }
        }

        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            selectedSentences.clear();
            document.querySelectorAll('.sentence-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            updateSelectedCount();
            showSuccess('å·²æ¸…é™¤æ‰€æœ‰é€‰æ‹©');
        }

        // åˆ‡æ¢æ–‡æœ¬ç¼–è¾‘çŠ¶æ€
        function toggleTextEdit(index, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            const textElement = document.getElementById(`sentence-text-${index}`);
            const inputElement = document.getElementById(`sentence-edit-${index}`);
            const editBtn = event.target;
            
            if (textElement.style.display !== 'none') {
                // è¿›å…¥ç¼–è¾‘çŠ¶æ€
                textElement.style.display = 'none';
                inputElement.style.display = 'block';
                inputElement.focus();
                editBtn.textContent = 'ğŸ’¾ ä¿å­˜';
                editBtn.style.background = '#007bff';
            } else {
                // ä¿å­˜ç¼–è¾‘ç»“æœ
                const newText = inputElement.value.trim();
                if (newText === '') {
                    showError('æ–‡æœ¬å†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                // æ›´æ–°å½“å‰ç»“æœä¸­çš„æ–‡æœ¬
                if (currentResult && currentResult.sentences[index]) {
                    currentResult.sentences[index].text = newText;
                    textElement.textContent = newText;
                    
                    // é‡æ–°ç”Ÿæˆå®Œæ•´æ–‡æœ¬
                    currentResult.text = currentResult.sentences.map(s => s.text).join(' ');
                    document.getElementById('fullText').textContent = currentResult.text;
                    
                    // æ›´æ–°å­—ç¬¦æ•°ç»Ÿè®¡
                    document.getElementById('wordCount').textContent = currentResult.text.length;
                    
                    // è‡ªåŠ¨åŒæ­¥æ›´æ–°JSONæ–‡ä»¶
                    autoSyncResult();
                }
                
                // é€€å‡ºç¼–è¾‘çŠ¶æ€
                textElement.style.display = 'block';
                inputElement.style.display = 'none';
                editBtn.textContent = 'âœï¸ ç¼–è¾‘';
                editBtn.style.background = '#28a745';
                
                showSuccess('æ–‡æœ¬å·²ä¿å­˜å¹¶åŒæ­¥æ›´æ–°');
            }
        }

        // åˆå¹¶é€‰ä¸­çš„åˆ†å¥
        function mergeSelectedSentences() {
            if (selectedSentences.size < 2) {
                showError('è¯·è‡³å°‘é€‰æ‹©2ä¸ªåˆ†å¥è¿›è¡Œåˆå¹¶');
                return;
            }
            
            if (!currentResult || !currentResult.sentences) {
                showError('æ²¡æœ‰å¯ç”¨çš„è¯†åˆ«ç»“æœ');
                return;
            }
            
            // å°†é€‰ä¸­çš„ç´¢å¼•è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const selectedIndices = Array.from(selectedSentences).sort((a, b) => a - b);
            
            // æ£€æŸ¥é€‰ä¸­çš„åˆ†å¥æ˜¯å¦è¿ç»­
            let isConsecutive = true;
            for (let i = 1; i < selectedIndices.length; i++) {
                if (selectedIndices[i] !== selectedIndices[i-1] + 1) {
                    isConsecutive = false;
                    break;
                }
            }
            
            if (!isConsecutive) {
                if (!confirm('é€‰ä¸­çš„åˆ†å¥ä¸è¿ç»­ï¼Œåˆå¹¶åå¯èƒ½å½±å“æ—¶é—´è½´çš„è¿è´¯æ€§ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    return;
                }
            }
            
            // è·å–è¦åˆå¹¶çš„åˆ†å¥
            const sentencesToMerge = selectedIndices.map(index => currentResult.sentences[index]);
            
            // åˆ›å»ºåˆå¹¶åçš„åˆ†å¥
            const mergedSentence = {
                start: Math.min(...sentencesToMerge.map(s => s.start)),
                end: Math.max(...sentencesToMerge.map(s => s.end)),
                text: sentencesToMerge.map(s => s.text).join(' '),
                speaker: sentencesToMerge[0].speaker // ä½¿ç”¨ç¬¬ä¸€ä¸ªåˆ†å¥çš„è¯´è¯äºº
            };
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸åŒçš„è¯´è¯äºº
            const speakers = [...new Set(sentencesToMerge.map(s => s.speaker))];
            if (speakers.length > 1) {
                const speakerList = speakers.join(', ');
                if (!confirm(`é€‰ä¸­çš„åˆ†å¥åŒ…å«ä¸åŒçš„è¯´è¯äººï¼ˆ${speakerList}ï¼‰ï¼Œåˆå¹¶åå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªè¯´è¯äººï¼ˆ${speakers[0]}ï¼‰ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    return;
                }
            }
            
            // åˆ›å»ºæ–°çš„åˆ†å¥æ•°ç»„
            const newSentences = [];
            let mergedAdded = false;
            
            for (let i = 0; i < currentResult.sentences.length; i++) {
                if (selectedIndices.includes(i)) {
                    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé€‰ä¸­çš„åˆ†å¥ï¼Œæ·»åŠ åˆå¹¶åçš„åˆ†å¥
                    if (i === selectedIndices[0] && !mergedAdded) {
                        newSentences.push(mergedSentence);
                        mergedAdded = true;
                    }
                    // è·³è¿‡å…¶ä»–é€‰ä¸­çš„åˆ†å¥
                } else {
                    // ä¿ç•™æœªé€‰ä¸­çš„åˆ†å¥
                    newSentences.push(currentResult.sentences[i]);
                }
            }
            
            // æ›´æ–°å½“å‰ç»“æœ
            currentResult.sentences = newSentences;
            
            // é‡æ–°ç”Ÿæˆå®Œæ•´æ–‡æœ¬
            currentResult.text = newSentences.map(s => s.text).join(' ');
            
            // æ›´æ–°è¯´è¯äººåˆ—è¡¨
            currentResult.speakers = [...new Set(newSentences.map(s => s.speaker))];
            
            // è‡ªåŠ¨åŒæ­¥æ›´æ–°JSONæ–‡ä»¶
            autoSyncResult();
            
            // é‡æ–°æ˜¾ç¤ºç»“æœ
            displayResults(currentResult);
            
            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            toggleEditMode();
            
            showSuccess(`æˆåŠŸåˆå¹¶äº† ${selectedIndices.length} ä¸ªåˆ†å¥å¹¶åŒæ­¥æ›´æ–°ï¼`);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHistoryModal();
            }
        });

        // Check server health on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                if (health.status === 'healthy') {
                    console.log('Server is healthy');
                }
            } catch (error) {
                showError('æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ');
            }
        });
    </script>
</body>
</html>