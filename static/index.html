<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroMao - 离线语音识别</title>
    <!-- 引入crypto-js库用于MD5计算 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: visible;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-section.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            display: none;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-section {
            display: none;
        }

        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 150px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .full-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .sentences-container {
            background: white;
            border-radius: 10px;
            overflow: visible;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .sentences-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 10px 10px 0 0;
        }

        .sentences-list-wrapper {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            border-radius: 0 0 10px 10px;
        }

        .sentence-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .sentence-item:hover {
            background: #f0f8ff;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);
        }

        .sentence-item.playing {
            background: #e3f2fd;
            border-left: 4px solid #4facfe;
        }

        .sentence-item.edit-mode {
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .sentence-item.edit-mode:hover {
            background: #e8f5e8;
        }

        .sentence-item.selected {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .sentence-item.selected::before {
            content: '✓';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }

        .sentence-item::before {
            content: '🎵';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sentence-item:hover::before {
            opacity: 0.6;
        }

        .sentence-item:last-child {
            border-bottom: none;
        }

        .sentence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .speaker-tag {
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        .sentence-text {
            color: #333;
            line-height: 1.5;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #00b894;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .supported-formats {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats {
                flex-direction: column;
            }

            .sentence-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎙️ AstroMao</h1>
            <p>离线语音识别 · 说话人分离 · 中英文支持</p>
        </div>

        <div class="main-content">
            <div class="upload-section" id="uploadSection">
                <h3>📁 上传音频文件或导入识别结果</h3>
                <p>拖拽音频文件到此处或点击按钮选择文件，也可以导入之前保存的JSON结果文件</p>
                <input type="file" id="fileInput" class="file-input" accept=".wav,.mp3,.m4a,.flac,.aac,.ogg">
                <input type="file" id="jsonInput" class="file-input" accept=".json">
                <input type="file" id="audioForJsonInput" class="file-input" accept=".wav,.mp3,.m4a,.flac,.aac,.ogg" style="display: none;">
                <button class="upload-btn" id="uploadBtn">选择音频文件</button>
                <button class="upload-btn" id="importBtn" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">📥 导入JSON结果</button>
                <button class="upload-btn" id="selectAudioBtn" style="background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%); display: none;">🎵 选择对应音频</button>
                <button class="upload-btn" id="recognizeBtn" style="display: none;" disabled>开始识别</button>
                <button class="upload-btn" id="historyBtn" style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);">📋 历史记录</button>
                
                <div class="file-info" id="fileInfo">
                    <p><strong>文件名:</strong> <span id="fileName"></span></p>
                    <p><strong>文件大小:</strong> <span id="fileSize"></span></p>
                    <p><strong>文件类型:</strong> <span id="fileType"></span></p>
                </div>

                <div class="supported-formats">
                    音频格式: WAV, MP3, M4A, FLAC, AAC, OGG | 结果格式: JSON
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p style="text-align: center; margin-top: 10px;">正在处理音频文件...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h3>📊 识别结果</h3>
                    <!-- 音频播放器 -->
                    <audio id="audioPlayer" controls style="width: 100%; margin-top: 15px; display: none;">
                        您的浏览器不支持音频播放。
                    </audio>
                </div>

                <div class="stats" id="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDuration">0</div>
                        <div class="stat-label">总时长 (秒)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="sentenceCount">0</div>
                        <div class="stat-label">句子数量</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="speakerCount">0</div>
                        <div class="stat-label">说话人数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="wordCount">0</div>
                        <div class="stat-label">字符数</div>
                    </div>
                </div>

                <div class="full-text">
                    <h4>📝 完整文本</h4>
                    <div id="fullText"></div>
                </div>

                <div class="result-actions" id="resultActions" style="display: none; padding: 20px; background: #f8f9fa; border-top: 1px solid #eee; text-align: center;">
                    <button onclick="saveResult()" style="background: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 0 10px; cursor: pointer;">💾 保存结果</button>
                    <button onclick="exportResult()" style="background: #4facfe; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 0 10px; cursor: pointer;">📥 导出JSON</button>
                </div>

                <div class="sentences-container">
                    <div class="sentences-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee;">
                            <h4 style="margin: 0;">🎯 分句结果</h4>
                            <div style="display: flex; gap: 10px;">
                                <button id="bilingualModeBtn" onclick="toggleBilingualMode()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-block; font-size: 14px; line-height: 1.4; text-align: center; vertical-align: middle; -webkit-appearance: none; -moz-appearance: none; appearance: none;" title="双语模式">🌐 双语模式</button>
                                <button id="editModeBtn" onclick="toggleEditMode()" style="background: #fd79a8; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-block; font-size: 14px; line-height: 1.4; text-align: center; vertical-align: middle; -webkit-appearance: none; -moz-appearance: none; appearance: none;">✏️ 编辑模式</button>
                            </div>
                        </div>
                        <div id="editControlPanel" style="display: none; padding: 10px 20px; background: #f1f3f5; border-bottom: 1px solid #eee;">
                            <span id="selectedCount" style="margin-right: 15px; font-weight: bold;">已选择: 0</span>
                            <button id="mergeBtn" onclick="mergeSelectedSentences()" style="background: #20c997; color: white; border: none; padding: 5px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer; opacity: 0.6;" disabled>🔄 合并选中</button>
                            <button onclick="clearSelection()" style="background: #868e96; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">❌ 清除选择</button>
                        </div>
                    </div>
                    <div class="sentences-list-wrapper">
                        <div id="sentencesList"></div>
                    </div>
                </div>
            </div>

            <!-- 历史记录模态框 -->
            <div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>📋 识别结果历史记录</h3>
                        <button onclick="closeHistoryModal()" style="background: #ddd; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">✕</button>
                    </div>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const jsonInput = document.getElementById('jsonInput');
        const audioForJsonInput = document.getElementById('audioForJsonInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const importBtn = document.getElementById('importBtn');
        const selectAudioBtn = document.getElementById('selectAudioBtn');
        const recognizeBtn = document.getElementById('recognizeBtn');
        const historyBtn = document.getElementById('historyBtn');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        let selectedFile = null;
        let importedJsonData = null;
        let selectedAudioForJson = null;
        
        // 将秒数转换为时分秒格式
        function formatTimeToHMS(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const millisecs = Math.floor((seconds % 1) * 100);
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millisecs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millisecs.toString().padStart(2, '0')}`;
            }
        }
        
        // 确保DOM加载完成
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM已加载完成');
            // 检查关键元素是否存在
            const editModeBtn = document.getElementById('editModeBtn');
            const editControlPanel = document.getElementById('editControlPanel');
            const bilingualModeBtn = document.getElementById('bilingualModeBtn');
            console.log('编辑模式按钮:', editModeBtn);
            console.log('编辑控制面板:', editControlPanel);
            console.log('双语模式按钮:', bilingualModeBtn);
        });

        // File input change event
        fileInput.addEventListener('change', handleFileSelect);
        jsonInput.addEventListener('change', handleJsonImport);
        audioForJsonInput.addEventListener('change', handleAudioForJsonSelect);
        uploadBtn.addEventListener('click', () => fileInput.click());
        importBtn.addEventListener('click', () => jsonInput.click());
        selectAudioBtn.addEventListener('click', () => audioForJsonInput.click());
        recognizeBtn.addEventListener('click', recognizeAudio);
        historyBtn.addEventListener('click', showResultsHistory);

        // Drag and drop events
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // 重置JSON导入相关状态
                resetJsonImportState();
                handleFile(file);
            }
        }

        function handleFile(file) {
            selectedFile = file;
            
            // Display file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || 'Unknown';
            
            fileInfo.style.display = 'block';
            recognizeBtn.style.display = 'inline-block';
            recognizeBtn.disabled = false;
            
            hideMessages();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function recognizeAudio() {
            if (!selectedFile) {
                alert('音频文件未加载，请先选择音频文件');
                return;
            }

            const formData = new FormData();
            formData.append('audio', selectedFile);

            // Show progress
            progressContainer.style.display = 'block';
            recognizeBtn.disabled = true;
            recognizeBtn.innerHTML = '<span class="loading"></span>识别中...';
            hideMessages();
            resultsSection.style.display = 'none';

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
            }, 200);

            try {
                const response = await fetch('/api/recognize', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    recognizeBtn.disabled = false;
                    recognizeBtn.innerHTML = '重新识别';

                    if (result.success) {
                        displayResults(result);
                        
                        // 识别完成后自动保存音频文件到results文件夹
                        if (selectedFile && result.result_id) {
                            console.log('识别完成，开始保存音频文件到results文件夹...');
                            uploadAudioForResult(selectedFile, result.result_id);
                        }
                        
                        showSuccess('识别完成！');
                    } else {
                        showError(result.message || '识别失败');
                    }
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                progressContainer.style.display = 'none';
                progressFill.style.width = '0%';
                recognizeBtn.disabled = false;
                recognizeBtn.innerHTML = '开始识别';
                showError('网络错误: ' + error.message);
            }
        }

        let currentResult = null; // 存储当前识别结果
        let audioPlayer = null; // 音频播放器引用
        let currentAudioFile = null; // 当前音频文件
        let isEditMode = false; // 编辑模式状态
        let isBilingualMode = true; // 双语模式状态，默认开启
        let selectedSentences = new Set(); // 选中的分句索引

        function displayResults(result) {
            currentResult = result; // 保存当前结果
            
            // Update statistics
            document.getElementById('totalDuration').textContent = result.total_duration || 0;
            document.getElementById('sentenceCount').textContent = result.sentences.length;
            document.getElementById('speakerCount').textContent = result.speakers.length;
            document.getElementById('wordCount').textContent = result.text.length;

            // Display full text
            document.getElementById('fullText').textContent = result.text;

            // 设置音频播放器
            setupAudioPlayer();

            // Display sentences
            const sentencesList = document.getElementById('sentencesList');
            sentencesList.innerHTML = '';

            result.sentences.forEach((sentence, index) => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-item';
                sentenceDiv.dataset.start = sentence.start;
                sentenceDiv.dataset.end = sentence.end;
                sentenceDiv.dataset.index = index;
                
                const speakerColors = ['#4facfe', '#00f2fe', '#667eea', '#764ba2', '#f093fb', '#f5576c'];
                const speakerColor = speakerColors[index % speakerColors.length];
                
                // 构建翻译显示内容
                let translationHtml = '';
                if (sentence.translation) {
                    const sourceFlag = sentence.translation.source_lang === 'zh' ? '🇨🇳' : '🇺🇸';
                    const targetFlag = sentence.translation.source_lang === 'zh' ? '🇺🇸' : '🇨🇳';
                    
                    const displayStyle = isBilingualMode ? 'block' : 'none';
                    translationHtml = `
                        <div class="translation-content translation-section" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #4facfe; display: ${displayStyle};">
                            <div class="translation-item" style="margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #666; font-size: 12px;">${sourceFlag} 原文:</span>
                                <div style="margin-top: 3px; color: #333;">${sentence.text}</div>
                            </div>
                            <div class="translation-item">
                                <span style="font-weight: bold; color: #666; font-size: 12px;">${targetFlag} 翻译:</span>
                                <div style="margin-top: 3px; color: #555; font-style: italic;">${sentence.translation.source_lang === 'zh' ? sentence.translation.en : sentence.translation.zh}</div>
                            </div>
                        </div>
                    `;
                }
                
                sentenceDiv.innerHTML = `
                    <div class="sentence-header">
                        <span class="speaker-tag" style="background: ${speakerColor}">${sentence.speaker}</span>
                        <span class="timestamp">🎵 ${formatTimeToHMS(sentence.start)} - ${formatTimeToHMS(sentence.end)} (点击播放)</span>
                        <button class="edit-text-btn" onclick="toggleTextEdit(${index}, event)" style="display: none; background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px;">✏️ 编辑</button>
                    </div>
                    <div class="sentence-text" id="sentence-text-${index}">${sentence.text}</div>
                    <textarea class="sentence-edit-input" id="sentence-edit-${index}" style="display: none; width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;">${sentence.text}</textarea>
                    ${translationHtml}
                `;
                
                // 添加点击事件监听器
                sentenceDiv.addEventListener('click', (e) => {
                    if (isEditMode) {
                        e.preventDefault();
                        toggleSentenceSelection(index, sentenceDiv);
                    } else {
                        playAudioSegment(sentence.start, sentence.end, sentenceDiv);
                    }
                });
                
                sentencesList.appendChild(sentenceDiv);
            });

            // 显示操作按钮
            document.getElementById('resultActions').style.display = 'block';
            
            resultsSection.style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // 重置JSON导入相关状态
        function resetJsonImportState() {
            importedJsonData = null;
            selectedAudioForJson = null;
            selectAudioBtn.style.display = 'none';
            selectAudioBtn.textContent = '🎵 选择对应音频';
            selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
            audioForJsonInput.value = '';
        }

        // 处理JSON文件导入
        function handleJsonImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 重置之前的状态
            resetJsonImportState();

            if (!file.name.toLowerCase().endsWith('.json')) {
                showError('请选择JSON格式的文件');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    console.log('开始解析JSON文件:', file.name);
                    const jsonData = JSON.parse(event.target.result);
                    console.log('JSON解析成功，数据结构:', jsonData);
                    
                    // 验证JSON格式是否正确
                    if (!validateJsonFormat(jsonData)) {
                        showError('JSON文件格式不正确。请检查浏览器控制台查看详细错误信息。确保文件包含必要字段：text、sentences、speakers');
                        return;
                    }

                    // 确保数据包含必要的统计信息
                    if (!jsonData.total_duration) {
                        jsonData.total_duration = jsonData.sentences.length > 0 ? 
                            Math.max(...jsonData.sentences.map(s => s.end)) : 0;
                    }

                    // 保存导入的JSON数据
                    importedJsonData = jsonData;
                    
                    // 显示导入的结果
                    displayResults(jsonData);
                    
                    // 显示选择音频按钮（如果JSON包含audio_hash）
                    if (jsonData.audio_hash) {
                        selectAudioBtn.style.display = 'inline-block';
                        const audioFileName = jsonData.filename ? `（原音频文件：${jsonData.filename}）` : '';
                        showSuccess(`成功导入识别结果：${file.name}。如需播放音频，请选择对应的音频文件进行验证${audioFileName}。`);
                    } else {
                        const audioFileName = jsonData.filename ? `（原音频文件：${jsonData.filename}）` : '';
                        showSuccess(`成功导入识别结果：${file.name}${audioFileName}`);
                    }
                    
                    // 隐藏文件信息和识别按钮
                    fileInfo.style.display = 'none';
                    recognizeBtn.style.display = 'none';
                    
                } catch (error) {
                    console.error('JSON解析错误:', error);
                    showError('JSON文件解析失败：' + error.message + '。请确保文件是有效的JSON格式。');
                }
            };
            
            reader.onerror = function() {
                showError('文件读取失败');
            };
            
            reader.readAsText(file);
        }

        // 验证JSON格式
        function validateJsonFormat(data) {
            // 检查必要的字段
            const requiredFields = ['text', 'sentences', 'speakers'];
            for (const field of requiredFields) {
                if (!(field in data)) {
                    console.log(`Missing required field: ${field}`);
                    return false;
                }
            }

            // 检查sentences数组格式
            if (!Array.isArray(data.sentences)) {
                console.log('sentences is not an array');
                return false;
            }

            // 检查每个句子的格式（更宽松的验证）
            for (let i = 0; i < data.sentences.length; i++) {
                const sentence = data.sentences[i];
                if (!sentence.hasOwnProperty('text')) {
                    console.log(`Sentence ${i} missing text field`);
                    return false;
                }
                if (!sentence.hasOwnProperty('start') || typeof sentence.start !== 'number') {
                    console.log(`Sentence ${i} missing or invalid start field`);
                    return false;
                }
                if (!sentence.hasOwnProperty('end') || typeof sentence.end !== 'number') {
                    console.log(`Sentence ${i} missing or invalid end field`);
                    return false;
                }
                if (!sentence.hasOwnProperty('speaker')) {
                    console.log(`Sentence ${i} missing speaker field`);
                    return false;
                }
            }

            // 检查speakers数组
            if (!Array.isArray(data.speakers)) {
                console.log('speakers is not an array');
                return false;
            }

            console.log('JSON validation passed');
            return true;
        }

        // 处理音频文件选择（用于JSON导入后的音频验证）
        function handleAudioForJsonSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!importedJsonData) {
                alert('音频文件未加载：请先导入JSON结果文件');
                return;
            }

            // 检查文件类型
            const allowedTypes = ['audio/wav', 'audio/mpeg', 'audio/mp4', 'audio/flac', 'audio/aac', 'audio/ogg'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(wav|mp3|m4a|flac|aac|ogg)$/i)) {
                alert('音频文件未加载：不支持的音频格式，请选择wav、mp3、m4a、flac、aac或ogg格式的文件');
                return;
            }

            // 显示处理状态
             showSuccess('正在计算音频文件hash值，请稍候...');
             
             // 计算音频文件的MD5 hash
             const reader = new FileReader();
             reader.onload = function(event) {
                 try {
                     const arrayBuffer = event.target.result;
                     const calculatedHash = calculateMD5Hash(arrayBuffer);
                     
                     console.log('计算的音频hash:', calculatedHash);
                     console.log('JSON中的hash:', importedJsonData.audio_hash);
                     
                     if (calculatedHash === importedJsonData.audio_hash) {
                         // Hash匹配，设置音频文件
                         selectedAudioForJson = file;
                         selectedFile = file; // 设置为当前音频文件
                         setupAudioPlayer(file);
                         
                         // 上传音频文件到服务器并更新JSON
                         uploadAudioForResult(file, importedJsonData.result_id);
                         
                         showSuccess(`音频文件验证成功！Hash值匹配，现在可以播放音频片段。`);
                         selectAudioBtn.textContent = '✅ 音频已验证';
                         selectAudioBtn.style.background = 'linear-gradient(135deg, #00b894 0%, #00cec9 100%)';
                     } else {
                         alert(`音频文件未加载：Hash值不匹配，请选择正确的音频文件\n期望: ${importedJsonData.audio_hash}\n实际: ${calculatedHash}`);
                     }
                 } catch (error) {
                     console.error('Hash计算错误:', error);
                     alert('音频文件未加载：hash计算失败 - ' + error.message);
                 }
             };
            
            reader.onerror = function() {
                alert('音频文件未加载：文件读取失败，请重新选择音频文件');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 使用crypto-js计算MD5 hash
         function calculateMD5Hash(arrayBuffer) {
             // 将ArrayBuffer转换为WordArray
             const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
             // 计算MD5 hash
             const hash = CryptoJS.MD5(wordArray).toString();
             return hash;
         }

        // 上传音频文件到服务器并更新JSON
         async function uploadAudioForResult(audioFile, resultId) {
             console.log('开始上传音频文件:', audioFile.name, 'resultId:', resultId);
             try {
                 const formData = new FormData();
                 formData.append('audio', audioFile);
                 
                 console.log('发送上传请求到:', `/api/upload_audio/${resultId}`);
                 const response = await fetch(`/api/upload_audio/${resultId}`, {
                     method: 'POST',
                     body: formData
                 });
                 
                 console.log('上传响应状态:', response.status);
                 const result = await response.json();
                 console.log('上传响应结果:', result);
                 
                 if (result.success) {
                     // 更新JSON数据中的音频路径
                     if (importedJsonData) {
                         importedJsonData.audio_path = result.audio_path;
                         console.log('已更新 importedJsonData.audio_path:', result.audio_path);
                     }
                     // 同时更新currentResult中的音频路径
                     if (currentResult) {
                         currentResult.audio_path = result.audio_path;
                         console.log('已更新 currentResult.audio_path:', result.audio_path);
                     }
                     // 自动同步更新到服务器
                     console.log('开始自动同步结果到服务器...');
                     await autoSyncResult();
                     console.log('音频文件已上传并保存路径到JSON:', result.audio_path);
                 } else {
                     console.error('音频文件上传失败:', result.message);
                 }
             } catch (error) {
                 console.error('音频文件上传错误:', error);
             }
         }

         // 从服务器加载保存的音频文件
         async function loadSavedAudioFile(audioPath) {
             try {
                 const response = await fetch(`/api/audio/${audioPath}`);
                 if (response.ok) {
                     const audioBlob = await response.blob();
                     const audioFile = new File([audioBlob], audioPath, { type: audioBlob.type });
                     
                     // 设置为当前音频文件
                     selectedFile = audioFile;
                     selectedAudioForJson = audioFile;
                     
                     // 设置音频播放器
                     setupAudioPlayer(audioFile);
                     
                     console.log('保存的音频文件已加载:', audioPath);
                 } else {
                     console.error('加载保存的音频文件失败:', response.statusText);
                     // 如果音频文件不存在，显示选择音频按钮
                     if (importedJsonData && importedJsonData.audio_hash) {
                         selectAudioBtn.style.display = 'inline-block';
                         selectAudioBtn.textContent = '🎵 选择对应音频';
                         selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
                     }
                 }
             } catch (error) {
                 console.error('加载保存的音频文件错误:', error);
                 // 如果加载失败，显示选择音频按钮
                 if (importedJsonData && importedJsonData.audio_hash) {
                     selectAudioBtn.style.display = 'inline-block';
                     selectAudioBtn.textContent = '🎵 选择对应音频';
                     selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
                 }
             }
         }

        // 设置音频播放器
        function setupAudioPlayer(audioFile = null) {
            audioPlayer = document.getElementById('audioPlayer');
            const fileToUse = audioFile || selectedFile;
            
            if (fileToUse && currentAudioFile !== fileToUse) {
                currentAudioFile = fileToUse;
                const audioURL = URL.createObjectURL(fileToUse);
                audioPlayer.src = audioURL;
                audioPlayer.style.display = 'block';
                
                // 清理之前的URL对象
                audioPlayer.addEventListener('loadstart', () => {
                    if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
                        // 不立即清理，等播放完成后再清理
                    }
                });
            }
        }

        // 播放音频片段
        function playAudioSegment(startTime, endTime, sentenceElement) {
            if (!audioPlayer || !audioPlayer.src) {
                alert('音频文件未加载，请先选择并加载音频文件');
                return;
            }

            // 移除之前的播放状态
            document.querySelectorAll('.sentence-item.playing').forEach(item => {
                item.classList.remove('playing');
            });

            // 添加当前播放状态
            sentenceElement.classList.add('playing');

            // 设置播放时间
            audioPlayer.currentTime = startTime;
            
            // 播放音频
            audioPlayer.play().catch(error => {
                console.error('播放失败:', error);
                alert('音频文件未加载或播放失败，请检查文件格式或重新选择音频文件');
                sentenceElement.classList.remove('playing');
            });

            // 监听时间更新，在指定时间停止
            const timeUpdateHandler = () => {
                if (audioPlayer.currentTime >= endTime) {
                    audioPlayer.pause();
                    sentenceElement.classList.remove('playing');
                    audioPlayer.removeEventListener('timeupdate', timeUpdateHandler);
                }
            };

            audioPlayer.addEventListener('timeupdate', timeUpdateHandler);

            // 如果用户手动暂停，也要移除播放状态
            const pauseHandler = () => {
                sentenceElement.classList.remove('playing');
                audioPlayer.removeEventListener('timeupdate', timeUpdateHandler);
                audioPlayer.removeEventListener('pause', pauseHandler);
            };

            audioPlayer.addEventListener('pause', pauseHandler);
        }

        // 自动同步更新结果到JSON文件
        async function autoSyncResult() {
            if (!currentResult || !currentResult.result_id) {
                // 如果没有result_id，说明还没有保存过，先保存
                await saveResult();
                return;
            }

            try {
                const response = await fetch(`/api/update_result/${currentResult.result_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentResult)
                });

                const result = await response.json();
                if (result.success) {
                    console.log('结果已自动同步更新');
                } else {
                    console.error('自动同步失败:', result.message);
                }
            } catch (error) {
                console.error('自动同步失败:', error.message);
            }
        }

        // 保存识别结果
        async function saveResult() {
            if (!currentResult) {
                showError('没有可保存的结果');
                return;
            }

            try {
                const response = await fetch('/api/save_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentResult)
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess(`结果已保存！ID: ${result.result_id}`);
                } else {
                    showError('保存失败: ' + result.message);
                }
            } catch (error) {
                showError('保存失败: ' + error.message);
            }
        }

        // 导出识别结果
        async function exportResult() {
            if (!currentResult || !currentResult.result_id) {
                showError('请先保存结果再导出');
                return;
            }

            try {
                const link = document.createElement('a');
                link.href = `/api/export/${currentResult.result_id}`;
                link.download = `astromao_result_${currentResult.result_id}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('结果已导出！');
            } catch (error) {
                showError('导出失败: ' + error.message);
            }
        }

        // 显示历史记录
        async function showResultsHistory() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();
                
                if (data.success) {
                    displayHistoryList(data.results);
                    document.getElementById('historyModal').style.display = 'block';
                } else {
                    showError('获取历史记录失败');
                }
            } catch (error) {
                showError('获取历史记录失败: ' + error.message);
            }
        }

        // 显示历史记录列表
        function displayHistoryList(results) {
            const historyList = document.getElementById('historyList');
            
            if (results.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666;">暂无历史记录</p>';
                return;
            }

            historyList.innerHTML = results.map(result => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${result.filename}</strong>
                            ${result.original_filename ? `<div style="color: #666; font-size: 0.85em; margin-top: 2px;">原音频: ${result.original_filename}</div>` : ''}
                        </div>
                        <span style="color: #666; font-size: 0.9em;">${new Date(result.timestamp).toLocaleString()}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <div style="color: #666; font-size: 0.9em;">音频Hash: ${result.audio_hash}</div>
                        <div style="color: #666; font-size: 0.9em;">时长: ${result.total_duration}秒 | 说话人: ${result.speakers_count} | 句子: ${result.sentences_count}</div>
                    </div>
                    <div style="margin-bottom: 10px; color: #333;">${result.text_preview}</div>
                    <div style="text-align: right;">
                        <button onclick="loadHistoryResult('${result.result_id}')" style="background: #00b894; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 5px; cursor: pointer;">📂 加载</button>
                        <button onclick="exportHistoryResult('${result.result_id}')" style="background: #4facfe; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 5px; cursor: pointer;">📥 导出</button>
                        <button onclick="deleteHistoryResult('${result.result_id}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 5px; cursor: pointer;">🗑️ 删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 加载历史记录结果
        async function loadHistoryResult(resultId) {
            try {
                const response = await fetch(`/api/export/${resultId}`);
                if (!response.ok) {
                    throw new Error('获取历史记录失败');
                }
                
                const jsonData = await response.json();
                
                // 关闭历史记录模态框
                closeHistoryModal();
                
                // 重置状态
                resetJsonImportState();
                selectedFile = null;
                
                // 设置导入的JSON数据
                importedJsonData = jsonData;
                
                // 重要：为历史记录数据设置result_id，以便后续编辑时能正确更新
                jsonData.result_id = resultId;
                
                // 显示结果
                displayResults(jsonData);
                
                // 检查是否有保存的音频路径
                if (jsonData.audio_path) {
                    // 自动加载保存的音频文件
                    loadSavedAudioFile(jsonData.audio_path);
                    const audioFileName = jsonData.filename ? `（原音频文件：${jsonData.filename}）` : '';
                    showSuccess(`历史记录已加载！音频文件已自动加载${audioFileName}`);
                } else if (jsonData.audio_hash) {
                    // 如果有音频哈希但没有保存的音频路径，显示选择音频按钮
                    selectAudioBtn.style.display = 'inline-block';
                    selectAudioBtn.textContent = '🎵 选择对应音频';
                    selectAudioBtn.style.background = 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)';
                    const audioFileName = jsonData.filename ? `（原音频文件：${jsonData.filename}）` : '';
                    showSuccess(`历史记录已加载！请选择对应的音频文件进行验证${audioFileName}（音频哈希: ${jsonData.audio_hash.substring(0, 8)}...）`);
                } else {
                    const audioFileName = jsonData.filename ? `（原音频文件：${jsonData.filename}）` : '';
                    showSuccess(`历史记录已加载！${audioFileName}`);
                }
                
                // 隐藏文件信息和识别按钮
                fileInfo.style.display = 'none';
                recognizeBtn.style.display = 'none';
                
            } catch (error) {
                showError('加载历史记录失败: ' + error.message);
            }
        }

        // 导出历史记录结果
        async function exportHistoryResult(resultId) {
            try {
                const link = document.createElement('a');
                link.href = `/api/export/${resultId}`;
                link.download = `astromao_result_${resultId}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('结果已导出！');
            } catch (error) {
                showError('导出失败: ' + error.message);
            }
        }

        // 删除历史记录结果
        async function deleteHistoryResult(resultId) {
            if (!confirm('确定要删除这个结果吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/results/${resultId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess('结果已删除！');
                    showResultsHistory(); // 刷新历史记录列表
                } else {
                    showError('删除失败: ' + result.message);
                }
            } catch (error) {
                showError('删除失败: ' + error.message);
            }
        }

        // 关闭历史记录模态框
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // 切换编辑模式
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editModeBtn = document.getElementById('editModeBtn');
            const editControlPanel = document.getElementById('editControlPanel');
            const sentenceItems = document.querySelectorAll('.sentence-item');
            
            // 添加错误检查
            if (!editModeBtn) {
                console.error('编辑模式按钮未找到');
                return;
            }
            if (!editControlPanel) {
                console.error('编辑控制面板未找到');
                return;
            }
            
            if (isEditMode) {
                // 进入编辑模式
                editModeBtn.textContent = '👁️ 查看模式';
                editModeBtn.style.background = '#17a2b8';
                editControlPanel.style.display = 'block';
                
                // 为所有分句添加编辑模式样式
                sentenceItems.forEach(item => {
                    item.classList.add('edit-mode');
                });
                
                // 显示所有编辑按钮
                document.querySelectorAll('.edit-text-btn').forEach(btn => {
                    btn.style.display = 'inline-block';
                });
                
                showSuccess('已进入编辑模式，点击分句进行选择，可选择多个分句进行合并，或点击编辑按钮修改文本');
            } else {
                // 退出编辑模式
                editModeBtn.textContent = '✏️ 编辑模式';
                editModeBtn.style.background = '#fd79a8';
                editControlPanel.style.display = 'none';
                
                // 移除编辑模式样式和选中状态
                sentenceItems.forEach(item => {
                    item.classList.remove('edit-mode', 'selected');
                });
                
                // 隐藏所有编辑按钮
                document.querySelectorAll('.edit-text-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // 退出所有文本编辑状态
                document.querySelectorAll('.sentence-edit-input').forEach(input => {
                    input.style.display = 'none';
                });
                document.querySelectorAll('.sentence-text').forEach(text => {
                    text.style.display = 'block';
                });
                
                // 清除选择
                selectedSentences.clear();
                updateSelectedCount();
                
                showSuccess('已退出编辑模式');
            }
        }

        // 切换双语模式
        function toggleBilingualMode() {
            isBilingualMode = !isBilingualMode;
            const bilingualModeBtn = document.getElementById('bilingualModeBtn');
            
            if (!bilingualModeBtn) {
                console.error('双语模式按钮未找到');
                return;
            }
            
            if (isBilingualMode) {
                // 开启双语模式
                bilingualModeBtn.textContent = '🌐 双语模式';
                bilingualModeBtn.style.background = '#28a745';
                bilingualModeBtn.title = '双语模式';
                
                // 显示所有翻译内容
                document.querySelectorAll('.translation-content').forEach(element => {
                    element.style.display = 'block';
                });
                
                showSuccess('已开启双语模式，显示翻译内容');
            } else {
                // 关闭双语模式
                bilingualModeBtn.textContent = '🔤 单语模式';
                bilingualModeBtn.style.background = '#6c757d';
                bilingualModeBtn.title = '单语模式';
                
                // 隐藏所有翻译内容
                document.querySelectorAll('.translation-content').forEach(element => {
                    element.style.display = 'none';
                });
                
                showSuccess('已关闭双语模式，隐藏翻译内容');
            }
        }

        // 切换分句选择状态
        function toggleSentenceSelection(index, sentenceElement) {
            if (selectedSentences.has(index)) {
                selectedSentences.delete(index);
                sentenceElement.classList.remove('selected');
            } else {
                selectedSentences.add(index);
                sentenceElement.classList.add('selected');
            }
            
            updateSelectedCount();
        }

        // 更新选中计数
        function updateSelectedCount() {
            const count = selectedSentences.size;
            document.getElementById('selectedCount').textContent = count;
            
            const mergeBtn = document.getElementById('mergeBtn');
            mergeBtn.disabled = count < 2;
            
            if (count >= 2) {
                mergeBtn.style.background = '#28a745';
                mergeBtn.style.cursor = 'pointer';
            } else {
                mergeBtn.style.background = '#6c757d';
                mergeBtn.style.cursor = 'not-allowed';
            }
        }

        // 清除选择
        function clearSelection() {
            selectedSentences.clear();
            document.querySelectorAll('.sentence-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            updateSelectedCount();
            showSuccess('已清除所有选择');
        }

        // 切换文本编辑状态
        function toggleTextEdit(index, event) {
            event.stopPropagation(); // 阻止事件冒泡
            
            const textElement = document.getElementById(`sentence-text-${index}`);
            const inputElement = document.getElementById(`sentence-edit-${index}`);
            const editBtn = event.target;
            
            if (textElement.style.display !== 'none') {
                // 进入编辑状态
                textElement.style.display = 'none';
                inputElement.style.display = 'block';
                inputElement.focus();
                editBtn.textContent = '💾 保存';
                editBtn.style.background = '#007bff';
            } else {
                // 保存编辑结果
                const newText = inputElement.value.trim();
                if (newText === '') {
                    showError('文本内容不能为空');
                    return;
                }
                
                // 更新当前结果中的文本
                if (currentResult && currentResult.sentences[index]) {
                    currentResult.sentences[index].text = newText;
                    textElement.textContent = newText;
                    
                    // 重新生成完整文本
                    currentResult.text = currentResult.sentences.map(s => s.text).join(' ');
                    document.getElementById('fullText').textContent = currentResult.text;
                    
                    // 更新字符数统计
                    document.getElementById('wordCount').textContent = currentResult.text.length;
                    
                    // 自动同步更新JSON文件
                    autoSyncResult();
                }
                
                // 退出编辑状态
                textElement.style.display = 'block';
                inputElement.style.display = 'none';
                editBtn.textContent = '✏️ 编辑';
                editBtn.style.background = '#28a745';
                
                showSuccess('文本已保存并同步更新');
            }
        }

        // 合并选中的分句
        function mergeSelectedSentences() {
            if (selectedSentences.size < 2) {
                showError('请至少选择2个分句进行合并');
                return;
            }
            
            if (!currentResult || !currentResult.sentences) {
                showError('没有可用的识别结果');
                return;
            }
            
            // 将选中的索引转换为数组并排序
            const selectedIndices = Array.from(selectedSentences).sort((a, b) => a - b);
            
            // 检查选中的分句是否连续
            let isConsecutive = true;
            for (let i = 1; i < selectedIndices.length; i++) {
                if (selectedIndices[i] !== selectedIndices[i-1] + 1) {
                    isConsecutive = false;
                    break;
                }
            }
            
            if (!isConsecutive) {
                if (!confirm('选中的分句不连续，合并后可能影响时间轴的连贯性。是否继续？')) {
                    return;
                }
            }
            
            // 获取要合并的分句
            const sentencesToMerge = selectedIndices.map(index => currentResult.sentences[index]);
            
            // 创建合并后的分句
            const mergedSentence = {
                start: Math.min(...sentencesToMerge.map(s => s.start)),
                end: Math.max(...sentencesToMerge.map(s => s.end)),
                text: sentencesToMerge.map(s => s.text).join(' '),
                speaker: sentencesToMerge[0].speaker // 使用第一个分句的说话人
            };
            
            // 检查是否有不同的说话人
            const speakers = [...new Set(sentencesToMerge.map(s => s.speaker))];
            if (speakers.length > 1) {
                const speakerList = speakers.join(', ');
                if (!confirm(`选中的分句包含不同的说话人（${speakerList}），合并后将使用第一个说话人（${speakers[0]}）。是否继续？`)) {
                    return;
                }
            }
            
            // 创建新的分句数组
            const newSentences = [];
            let mergedAdded = false;
            
            for (let i = 0; i < currentResult.sentences.length; i++) {
                if (selectedIndices.includes(i)) {
                    // 如果是第一个选中的分句，添加合并后的分句
                    if (i === selectedIndices[0] && !mergedAdded) {
                        newSentences.push(mergedSentence);
                        mergedAdded = true;
                    }
                    // 跳过其他选中的分句
                } else {
                    // 保留未选中的分句
                    newSentences.push(currentResult.sentences[i]);
                }
            }
            
            // 更新当前结果
            currentResult.sentences = newSentences;
            
            // 重新生成完整文本
            currentResult.text = newSentences.map(s => s.text).join(' ');
            
            // 更新说话人列表
            currentResult.speakers = [...new Set(newSentences.map(s => s.speaker))];
            
            // 自动同步更新JSON文件
            autoSyncResult();
            
            // 重新显示结果
            displayResults(currentResult);
            
            // 退出编辑模式
            toggleEditMode();
            
            showSuccess(`成功合并了 ${selectedIndices.length} 个分句并同步更新！`);
        }

        // 点击模态框外部关闭
        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHistoryModal();
            }
        });

        // Check server health on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                if (health.status === 'healthy') {
                    console.log('Server is healthy');
                }
            } catch (error) {
                showError('服务器连接失败，请检查服务是否正常运行');
            }
        });
    </script>
</body>
</html>